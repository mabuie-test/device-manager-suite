<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dashboard - Devices</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div class="topbar">
    <h1>Device Manager — Dashboard</h1>
    <button id="logout">Logout</button>
  </div>
  <div class="container">
    <section>
      <h3>Generate Pair Code</h3>
      <button id="genPair">Criar Pair Code</button>
      <div id="pairResult"></div>
    </section>

    <section>
      <h3>Generate License</h3>
      <input id="licenseTo" placeholder="Issued to (nome/cliente)"/>
      <input id="licenseDays" placeholder="expires in days" type="number"/>
      <button id="genLicense">Gerar Licença</button>
      <div id="licenseResult"></div>
    </section>

    <section>
      <h3>Devices</h3>
      <div id="devicesList"></div>
    </section>

  </div>

  <script>
    const API = location.origin + '/api';
    const token = localStorage.getItem('token');
    if (!token) location.href = 'index.html';

    document.getElementById('logout').onclick = () => { localStorage.removeItem('token'); location.href='index.html'; };

    async function fetchDevices() {
      const out = document.getElementById('devicesList');
      out.innerHTML = '<p>Use API or check DB directly for registered devices. Devices appear after pairing.</p>';
    }

    document.getElementById('genPair').addEventListener('click', async () => {
      const res = await fetch(API + '/pair/create', { method:'POST', headers: { Authorization: 'Bearer ' + token }});
      const j = await res.json();
      if (j.ok) {
        document.getElementById('pairResult').innerText = `DeviceId: ${j.deviceId}  | PairCode: ${j.pairCode} (expires: ${new Date(j.expiresAt).toLocaleString()})`;
      } else document.getElementById('pairResult').innerText = JSON.stringify(j);
    });

    document.getElementById('genLicense').addEventListener('click', async () => {
      const issuedTo = document.getElementById('licenseTo').value || '';
      const expiresInDays = parseInt(document.getElementById('licenseDays').value || '30', 10);
      const res = await fetch(API + '/license/generate', {
        method:'POST',
        headers: { Authorization: 'Bearer ' + token, 'Content-Type':'application/json' },
        body: JSON.stringify({ issuedTo, expiresInDays })
      });
      const j = await res.json();
      if (j.ok) document.getElementById('licenseResult').innerText = `Key: ${j.key} (expires: ${j.expiresAt})`;
      else document.getElementById('licenseResult').innerText = JSON.stringify(j);
    });

    fetchDevices();
  </script>
</body>
</html>
