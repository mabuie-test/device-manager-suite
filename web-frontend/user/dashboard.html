 <!doctype html>
<html>
<head><meta charset="utf-8"/><title>User Dashboard</title><link rel="stylesheet" href="/css/styles.css"></head>
<body>
  <div class="container">
    <header style="display:flex;justify-content:space-between;align-items:center">
      <h1>User Dashboard</h1>
      <div>
        <button id="logout">Logout</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h3>Profile</h3>
        <div id="profileHtml">Loading profile...</div>
      </div>

      <div class="card">
        <h3>Devices</h3> <div class="card" style="margin-bottom:12px">
  <h3>Reivindicar dispositivo</h3>
  <label>DeviceId: <input id="claimDeviceId" placeholder="Cole o DeviceId aqui" /></label>
  <button id="btnClaim">Reivindicar</button>
  <p id="claimMsg" class="small"></p>
</div>

        <table id="myDevices" style="width:100%;border-collapse:collapse">
          <thead><tr><th>DeviceId</th><th>Name</th><th>Last Seen</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>    <div style="margin-bottom:8px">
  <a id="linkMap" href="#">Ver Mapa</a> |
  <a id="linkNotifications" href="#">Notificações</a> |
  <a id="linkMessages" href="#">Mensagens</a> |
  <a id="linkCalls" href="#">Chamadas</a> |
  <a id="linkMedia" href="#">Media</a>
</div>

    </div>

    <div class="card" style="margin-top:12px">
      <h3>Enviar comprovativo de pagamento</h3>
      <input id="amount" type="number" placeholder="Amount" />
      <input id="method" placeholder="Method (e.g. bank transfer)" />
      <input id="note" placeholder="Note (optional)" />
      <input id="file" type="file" />
      <button id="sendPayment">Enviar</button>
      <p id="payMsg" class="small"></p>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Meus Pagamentos</h3>
      <table id="myPayments" style="width:100%;border-collapse:collapse">
        <thead><tr><th>ID</th><th>Amount</th><th>Status</th><th>Created</th><th>Comprovativo</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <script src="/js/api.js"></script>
  <script>
    const token = localStorage.getItem('auth_token');
    if (!token) { location.href = '/'; }

    document.getElementById('logout').addEventListener('click', ()=>{ localStorage.clear(); location.href='/' });

    async function loadProfile() {
      const r = await apiFetch('/api/auth/me', { method:'GET' });
      const el = document.getElementById('profileHtml');
      if (!r.ok) { el.innerText = 'Erro: ' + (r.error || JSON.stringify(r)); return; }
      const user = r.user;
      el.innerHTML = `
        <div><strong>Name:</strong> ${user.name || '-'}</div>
        <div><strong>Email:</strong> ${user.email || '-'}</div>
        <div><strong>Role:</strong> ${user.role || '-'}</div>
        <div><strong>Active:</strong> ${user.active ? 'Yes' : 'No'}</div>
      `;
      return user;
    }

    async function loadMyDevices() {
      const r = await apiFetch('/api/devices/my', { method:'GET' });
      const tbody = document.querySelector('#myDevices tbody');
      tbody.innerHTML = '';
      if (!r.ok) { tbody.innerHTML = '<tr><td colspan="4">Erro: ' + (r.error||JSON.stringify(r)) + '</td></tr>'; return; }
      r.devices.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:6px;border-bottom:1px solid #eee">${d.deviceId}</td>
          <td style="padding:6px;border-bottom:1px solid #eee">${d.name || ''}</td>
          <td style="padding:6px;border-bottom:1px solid #eee">${d.lastSeen ? new Date(d.lastSeen).toLocaleString() : '-'}</td>
          <td style="padding:6px;border-bottom:1px solid #eee"><button data-id="${d.deviceId}" class="btnView">Ver</button></td>
        `;
        tbody.appendChild(tr);
      });
// assume contexto: no admin -> leva para /admin/device.html, no user -> /user/device.html
document.querySelectorAll('.btnView').forEach(b => {
  b.addEventListener('click', () => {
    const id = b.getAttribute('data-id');
    // detecta se estamos no admin ou user pela URL atual
    const path = window.location.pathname;
    if (path.indexOf('/admin/') === 0 || path.indexOf('/admin') === 0) {
      window.location = '/admin/device.html?deviceId=' + encodeURIComponent(id);
    } else {
      window.location = '/user/device.html?deviceId=' + encodeURIComponent(id);
    }
  });
});

    }

    async function loadMyPayments() {
      const r = await apiFetch('/api/payments/mine', { method:'GET' });
      const tbody = document.querySelector('#myPayments tbody');
      tbody.innerHTML = '';
      if (!r.ok) { tbody.innerHTML = '<tr><td colspan="5">Erro: ' + (r.error||JSON.stringify(r)) + '</td></tr>'; return; }
      r.payments.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:6px;border-bottom:1px solid #eee">${p._id}</td>
          <td style="padding:6px;border-bottom:1px solid #eee">${p.amount || ''} ${p.currency || ''}</td>
          <td style="padding:6px;border-bottom:1px solid #eee">${p.status}</td>
          <td style="padding:6px;border-bottom:1px solid #eee">${new Date(p.createdAt).toLocaleString()}</td>
          <td style="padding:6px;border-bottom:1px solid #eee">${p.mediaFileId ? `<a href="/api/media/download/${p.mediaFileId}" target="_blank">Ver</a>` : '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // upload + create payment
    document.getElementById('sendPayment').addEventListener('click', async () => {
      const fileEl = document.getElementById('file');
      const amount = parseFloat(document.getElementById('amount').value || 0);
      const method = document.getElementById('method').value;
      const note = document.getElementById('note').value;
      if (fileEl.files.length === 0) { document.getElementById('payMsg').innerText = 'Escolhe um ficheiro'; return; }

      const form = new FormData();
      form.append('media', fileEl.files[0]);

      // upload to device "payment" bucket
      const uploadRes = await fetch('/api/media/payment/upload', { method:'POST', headers: { 'Authorization': 'Bearer ' + token }, body: form }).then(r=>r.json());
      if (!uploadRes.ok) { document.getElementById('payMsg').innerText = 'Upload failed: ' + JSON.stringify(uploadRes); return; }

      const mediaFileId = uploadRes.fileId;
      const createRes = await apiFetch('/api/payments', { method:'POST', body: { amount, method, note, mediaFileId } });
      if (createRes.ok) {
        document.getElementById('payMsg').innerText = 'Pagamento enviado. ID: ' + createRes.id;
        loadMyPayments();
      } else {
        document.getElementById('payMsg').innerText = 'Erro ao criar pagamento: ' + JSON.stringify(createRes);
      }
    });
document.getElementById('btnClaim').addEventListener('click', async () => {
  const id = document.getElementById('claimDeviceId').value.trim();
  if (!id) { document.getElementById('claimMsg').innerText = 'Insere deviceId'; return; }
  document.getElementById('claimMsg').innerText = 'A reivindicar...';
  const res = await apiFetch('/api/devices/' + encodeURIComponent(id) + '/claim', { method: 'POST' });
  if (res.ok) {
    document.getElementById('claimMsg').innerText = 'Device reivindicado com sucesso.';
    // recarrega lista de devices do user
    await loadMyDevices();
  } else {
    document.getElementById('claimMsg').innerText = 'Erro: ' + (res.error || JSON.stringify(res));
  }
});

    // init
    (async function(){
      await loadProfile();
      await loadMyDevices();
      await loadMyPayments();
    })();

  </script>
</body>
</html>
