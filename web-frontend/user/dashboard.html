 <!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Mapa do Dispositivo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height:480px; border-radius:8px; box-shadow: 0 6px 18px rgba(11,22,39,0.06); }
    .small { font-size:0.9rem; color:#6b7280; }
    .loader { display:inline-block;border:3px solid #f3f3f3;border-radius:50%;border-top:3px solid #2563eb;width:14px;height:14px;animation:spin 1s linear infinite;margin-left:8px;vertical-align:middle; }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .list-item { padding:8px;border-bottom:1px solid #eee }
    .list-item strong { display:block; margin-bottom:4px }
    .controls { display:flex; gap:10px; align-items:center; margin-bottom:8px }
    input#deviceId { padding:8px;border-radius:8px;border:1px solid #e6e9ef }
    button { padding:8px 12px;border-radius:8px;border:none;background:#2563eb;color:#fff; cursor:pointer }
    @media (max-width:600px){ #map{height:360px} .controls{flex-direction:column;align-items:stretch} button{width:100%} }
  </style>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <header style="display:flex;justify-content:space-between;align-items:center;margin:12px 0">
      <h1>Mapa</h1>
      <div>
        <a href="/user/dashboard.html">Voltar</a>
        <button id="logout">Logout</button>
      </div>
    </header>

    <div class="card">
      <div class="controls">
        <label style="flex:1">DeviceId: <input id="deviceId" placeholder="Cole o deviceId" /></label>
        <div style="display:flex;gap:8px">
          <button id="btnLoad">Carregar</button>
          <span id="status" class="small"></span>
        </div>
      </div>
    </div>

    <div id="map" class="card"></div>

    <div class="card">
      <h3>Últimos pontos</h3>
      <ul id="list" style="list-style:none;padding-left:0;margin:0"></ul>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script>
    // redirect to login if not authed
    const token = localStorage.getItem('auth_token');
    if (!token) location.href = '/';

    document.getElementById('logout').addEventListener('click', () => { localStorage.clear(); location.href = '/'; });

    const params = new URLSearchParams(window.location.search);
    if (params.get('deviceId')) document.getElementById('deviceId').value = params.get('deviceId');

    // leaflet map state
    let map = null;
    let markers = []; // array of L.marker
    function ensureMap() {
      if (!map) {
        map = L.map('map').setView([0,0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
      }
    }
    function clearMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
    }
    function addMarker(lat, lon, accuracy, ts) {
      const latN = parseFloat(lat);
      const lonN = parseFloat(lon);
      if (!isFinite(latN) || !isFinite(lonN)) return null;
      const timeStr = new Date(ts || Date.now()).toLocaleString();
      const gmapUrl = `https://www.google.com/maps/search/?api=1&query=${latN},${lonN}`;
      const popupHtml = `<div style="min-width:190px"><div><strong>${timeStr}</strong></div><div>Accuracy: ${accuracy||'-'}</div><div style="margin-top:8px"><a href="${gmapUrl}" target="_blank">Abrir no Google Maps</a></div></div>`;
      const m = L.marker([latN, lonN]).addTo(map);
      m.bindPopup(popupHtml);
      markers.push(m);
      return m;
    }

    // render list item (prepend if newest)
    function renderListPrepend(lat, lon, accuracy, ts) {
      const ul = document.getElementById('list');
      const timeStr = new Date(ts || Date.now()).toLocaleString();
      const gmapUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
      const li = document.createElement('li');
      li.className = 'list-item';
      li.innerHTML = `<strong>${timeStr}</strong>
        <div>Lat: ${parseFloat(lat).toFixed(6)} &nbsp; Lon: ${parseFloat(lon).toFixed(6)}</div>
        <div>Accuracy: ${accuracy||'-'}</div>
        <div style="margin-top:6px"><a href="${gmapUrl}" target="_blank">Abrir no Google Maps</a></div>`;
      ul.insertBefore(li, ul.firstChild);
    }

    // load history and init realtime
    async function load() {
      const deviceId = document.getElementById('deviceId').value.trim();
      const statusEl = document.getElementById('status');
      if (!deviceId) return alert('DeviceId required');

      statusEl.innerHTML = 'Carregando <span class="loader"></span>';
      ensureMap();
      clearMarkers();
      document.getElementById('list').innerHTML = '';

      try {
        const r = await apiFetch('/api/telemetry/' + encodeURIComponent(deviceId) + '/items?type=telemetry', { method: 'GET' });
        if (!r.ok) {
          statusEl.innerText = 'Erro a carregar histórico';
          document.getElementById('list').innerHTML = '<li class="list-item">Erro: ' + (r.error || JSON.stringify(r)) + '</li>';
          return;
        }
        const items = r.items || [];
        // sort ascending by ts so fitBounds natural path (older -> newer)
        items.sort((a,b) => {
          const at = a.ts || (a.payload && a.payload.ts) || 0;
          const bt = b.ts || (b.payload && b.payload.ts) || 0;
          return (at - bt);
        });

        const bounds = [];
        items.forEach(it => {
          const payload = it.payload || it;
          const loc = payload.location || {};
          const lat = parseFloat(loc.lat);
          const lon = parseFloat(loc.lon);
          const acc = loc.accuracy;
          const ts = payload.ts || it.ts || Date.now();
          if (isFinite(lat) && isFinite(lon)) {
            addMarker(lat, lon, acc, ts);
            bounds.push([lat, lon]);
            // append to list in chronological order; we'll invert view by scrolling later
            const ul = document.getElementById('list');
            const li = document.createElement('li');
            li.className = 'list-item';
            li.innerHTML = `<strong>${new Date(ts).toLocaleString()}</strong><div>Lat: ${lat.toFixed(6)} Lon: ${lon.toFixed(6)}</div><div>Accuracy: ${acc||'-'}</div><div style="margin-top:6px"><a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank">Abrir no Google Maps</a></div>`;
            ul.appendChild(li);
          }
        });

        if (bounds.length > 0) {
          try {
            map.fitBounds(bounds, { padding: [40,40], maxZoom: 16 });
          } catch (e) { map.setView(bounds[bounds.length-1], 13); }
        } else {
          map.setView([0,0], 2);
        }

        // realtime socket
        const socket = io();
        socket.emit('join_device_room', deviceId);
        // handle incoming telemetry events
        socket.off('telemetry'); // remove previous handlers
        socket.on('telemetry', data => {
          try {
            // data: { type: "telemetry", payload: { location: {lat,lon,accuracy}, ts } }
            const payload = data.payload || {};
            const loc = payload.location || {};
            const lat = parseFloat(loc.lat);
            const lon = parseFloat(loc.lon);
            const acc = loc.accuracy;
            const ts = payload.ts || data.ts || Date.now();
            if (isFinite(lat) && isFinite(lon)) {
              ensureMap();
              const m = addMarker(lat, lon, acc, ts);
              if (m) {
                m.openPopup();
                // keep map centered-ish on newest
                try { map.panTo([lat, lon]); } catch (e) {}
                // prepend to list
                renderListPrepend(lat, lon, acc, ts);
              }
            }
          } catch (e) {
            console.error('socket telemetry err', e);
          }
        });

        statusEl.innerText = 'OK';
      } catch (err) {
        console.error(err);
        statusEl.innerText = 'Erro na comunicação';
        document.getElementById('list').innerHTML = '<li class="list-item">Erro: ' + err.message + '</li>';
      }
    }

    document.getElementById('btnLoad').addEventListener('click', load);

    // auto-load if deviceId provided in query
    if (document.getElementById('deviceId').value) load();
  </script>
</body>
</html>
