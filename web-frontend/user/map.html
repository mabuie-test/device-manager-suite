 <!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Mapa do Dispositivo — Mobile Friendly</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif}
    .container{max-width:1100px;margin:12px auto;padding:12px}
    #map{height:56vh;min-height:320px;border-radius:8px;box-shadow:0 6px 18px rgba(11,22,39,0.06)}
    .card{background:#fff;padding:12px;border-radius:10px;margin-bottom:12px;box-shadow:0 6px 18px rgba(11,22,39,0.04)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    input{padding:8px;border-radius:8px;border:1px solid #e6e9ef;flex:1}
    button{padding:8px 12px;border-radius:8px;border:none;background:#2563eb;color:#fff}
    .small{font-size:0.9rem;color:#6b7280}
    .list-item{padding:8px;border-bottom:1px solid #eee}
    pre.raw{max-height:220px;overflow:auto;background:#0b1220;color:#e6f0ff;padding:10px;border-radius:8px}
    @media(max-width:600px){ .controls{flex-direction:column} button{width:100%} }
  </style>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <header style="display:flex;justify-content:space-between;align-items:center">
      <h2>Mapa do Dispositivo</h2>
      <div><a href="/user/dashboard.html">Voltar</a> <button id="logout">Logout</button></div>
    </header>

    <div class="card">
      <div class="controls">
        <input id="deviceId" placeholder="Cole aqui o deviceId (ou abra com ?deviceId=...)" />
        <button id="btnLoad">Carregar</button>
        <button id="btnClear" style="background:#eef6ff;color:#0b2f6c">Limpar</button>
      </div>
      <div style="margin-top:8px" id="status" class="small">Pronto</div>
    </div>

    <div id="map" class="card"></div>

    <div class="card">
      <h3>Últimos pontos</h3>
      <ul id="list" style="list-style:none;padding-left:0;margin:0;max-height:220px;overflow:auto"></ul>
    </div>

    <div class="card">
      <h3>Resposta bruta do backend (debug)</h3>
      <div class="small">Se não aparecer pontos, copia aqui o JSON e cola na conversa.</div>
      <pre id="raw" class="raw">Nenhum</pre>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script>
    // --- helpers
    function num(v){ if (v===null||v===undefined) return NaN; if (typeof v==='number') return v; return parseFloat(String(v).replace(',', '.')) }
    function fmtDate(ts){ try { return new Date(Number(ts)).toLocaleString(); } catch(e){ return String(ts) } }

    // extract payload.location.* in robust way (supports format you confirmed)
    function extractFrom(item){
      // if string, try parse
      if (typeof item === 'string'){
        try { item = JSON.parse(item); } catch(e){}
      }
      // prefer payload wrapper
      const wrapper = item && (item.payload || item['payload'] || item['carga útil'] || item['carga_util'] || item['carga']);
      const pl = (wrapper !== undefined && wrapper !== null) ? wrapper : item;
      // if payload string, parse
      let payload = pl;
      if (typeof payload === 'string') {
        try { payload = JSON.parse(payload); } catch(e){}
      }
      // location variants
      const loc = payload && (payload.location || payload.localizacao || payload['localização'] || payload.loc);
      let lat = NaN, lon = NaN, acc = null, ts = null;
      if (loc){
        const L = (typeof loc === 'string') ? (function(){ try { return JSON.parse(loc) } catch(e){ return loc } })() : loc;
        lat = num(L.lat || L.latitude || L.Lat);
        lon = num(L.lon || L.longitude || L.Lon);
        acc = L.accuracy || L.precision || L.precisao || L.precisão || null;
      } else {
        lat = num(payload.lat || payload.latitude || payload.Lat);
        lon = num(payload.lon || payload.longitude || payload.Lon);
        acc = payload.accuracy || payload.precision || null;
      }
      ts = payload.ts || payload.time || payload.timestamp || item.ts || item.time || Date.now();
      return { lat, lon, acc, ts, raw: item };
    }

    // --- leaflet state
    let map=null, markers=[], lastMarker=null, poly=null, latlngs=[];
    let socket=null, currentRoom=null;

    function ensureMap(){
      if (!map){
        map = L.map('map').setView([0,0],2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
      }
    }
    function clearAll(){
      if (!map) ensureMap();
      markers.forEach(m=>map.removeLayer(m)); markers=[];
      if (lastMarker){ map.removeLayer(lastMarker); lastMarker=null; }
      if (poly){ map.removeLayer(poly); poly=null; }
      latlngs=[];
      document.getElementById('list').innerHTML='';
      document.getElementById('raw').textContent='Nenhum';
      document.getElementById('status').innerText='Limpo';
      if (socket){ try{ socket.emit('leave_device_room', currentRoom); }catch(e){} try{ socket.disconnect(); }catch(e){} socket=null; currentRoom=null; }
    }

    function addPoint(lat, lon, acc, ts, openPopup){
      const la = Number(lat), lo = Number(lon);
      if (!isFinite(la) || !isFinite(lo)) return;
      // historic marker
      const m = L.circleMarker([la, lo], { radius:6, color:'#1976d2', fillColor:'#1976d2', fillOpacity:0.9 }).addTo(map);
      const popup = `<div style="min-width:160px"><div><strong>${fmtDate(ts)}</strong></div><div>Accuracy: ${acc||'-'}</div><div style="margin-top:6px"><a href="https://www.google.com/maps/search/?api=1&query=${la},${lo}" target="_blank">Abrir no Google Maps</a></div></div>`;
      m.bindPopup(popup);
      markers.push(m);
      latlngs.push([la, lo]);
      // update polyline
      if (poly) map.removeLayer(poly);
      if (latlngs.length >= 2) poly = L.polyline(latlngs, { color:'#2563eb', weight:4, opacity:0.9 }).addTo(map);
      // highlight last
      if (lastMarker) { map.removeLayer(lastMarker); lastMarker=null; }
      lastMarker = L.circleMarker([la, lo], { radius:9, color:'#16a34a', fillColor:'#16a34a', fillOpacity:0.95 }).addTo(map);
      lastMarker.bindPopup(popup);
      if (openPopup) try{ lastMarker.openPopup(); }catch(e){}
    }

    function prependList(lat, lon, acc, ts){
      const ul = document.getElementById('list');
      const li = document.createElement('li');
      li.className = 'list-item';
      li.innerHTML = `<strong>${fmtDate(ts)}</strong><div>Lat: ${Number(lat).toFixed(6)} Lon: ${Number(lon).toFixed(6)}</div><div>Accuracy: ${acc||'-'}</div><div style="margin-top:6px"><a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank">Abrir no Google Maps</a></div>`;
      ul.insertBefore(li, ul.firstChild);
    }

    // main load: fetch history, draw trail, setup socket
    async function load(){
      const deviceId = document.getElementById('deviceId').value.trim();
      if (!deviceId) return alert('Insira deviceId');
      ensureMap();
      // clear only markers/trail, keep map instance
      markers.forEach(m=>map.removeLayer(m)); markers=[]; if (lastMarker){ map.removeLayer(lastMarker); lastMarker=null; } if (poly){ map.removeLayer(poly); poly=null; } latlngs=[]; document.getElementById('list').innerHTML=''; document.getElementById('status').innerText='Carregando...';

      try {
        const res = await apiFetch('/api/telemetry/' + encodeURIComponent(deviceId) + '/items?type=telemetry', { method:'GET' });
        // mostrar resposta bruta
        try { document.getElementById('raw').textContent = JSON.stringify(res, null, 2); } catch(e){}
        // extrair array items OR usar res diretamente
        let items = [];
        if (!res) items = [];
        else if (Array.isArray(res)) items = res;
        else if (res.items && Array.isArray(res.items)) items = res.items;
        else if (res.data && Array.isArray(res.data)) items = res.data;
        else if (res.payload && Array.isArray(res.payload)) items = res.payload;
        else items = res.items || [];

        // percorre e extrai pontos
        const pts = [];
        for (let i=0;i<items.length;i++){
          const ext = extractFrom(items[i]);
          if (isFinite(Number(ext.lat)) && isFinite(Number(ext.lon))){
            pts.push(ext);
          }
        }

        if (pts.length === 0){
          document.getElementById('status').innerText = 'Nenhum ponto com lat/lon no histórico';
          map.setView([0,0],2);
        } else {
          // ordenar por timestamp asc
          pts.sort((a,b)=>Number(a.ts) - Number(b.ts));
          for (let i=0;i<pts.length;i++){
            addPoint(pts[i].lat, pts[i].lon, pts[i].acc, pts[i].ts, false);
          }
          // abrir popup na ultima
          const last = pts[pts.length-1];
          setTimeout(()=>{ try{ map.fitBounds(latlngs, { padding:[40,40], maxZoom:16 }); }catch(e){ map.setView([Number(last.lat), Number(last.lon)], 13); } }, 100);
          // popular lista (mais recente primeiro)
          for (let i=pts.length-1;i>=0;i--) prependList(pts[i].lat, pts[i].lon, pts[i].acc, pts[i].ts);
          document.getElementById('status').innerText = 'OK — ' + pts.length + ' pontos';
        }

        // socket: reconnect for realtime
        if (socket){ try{ socket.emit('leave_device_room', currentRoom); }catch(e){} try{ socket.disconnect(); }catch(e){} socket = null; currentRoom = null; }
        socket = io(window.location.origin, { transports:['websocket','polling'] });
        currentRoom = deviceId;
        socket.on('connect', ()=>{ console.log('socket connected', socket.id); socket.emit('join_device_room', deviceId); });
        socket.on('telemetry', d => { const ex = extractFrom(d); if (isFinite(Number(ex.lat)) && isFinite(Number(ex.lon))){ addPoint(ex.lat, ex.lon, ex.acc, ex.ts, true); prependList(ex.lat, ex.lon, ex.acc, ex.ts); } });
        socket.on('telemetria', d => { const ex = extractFrom(d); if (isFinite(Number(ex.lat)) && isFinite(Number(ex.lon))){ addPoint(ex.lat, ex.lon, ex.acc, ex.ts, true); prependList(ex.lat, ex.lon, ex.acc, ex.ts); } });
        socket.onAny((ev,p)=>console.log('socket event',ev,p));
      } catch (err){
        console.error('load err', err);
        document.getElementById('status').innerText = 'Erro ao carregar';
        try { document.getElementById('raw').textContent = String(err); } catch(e){}
      }
    }

    // bind UI
    document.getElementById('btnLoad').addEventListener('click', load);
    document.getElementById('btnClear').addEventListener('click', clearAll);
    document.getElementById('logout').addEventListener('click', ()=>{ localStorage.clear(); location.href='/' });

    // auto load if query param
    const q = new URLSearchParams(window.location.search);
    if (q.get('deviceId')) { document.getElementById('deviceId').value = q.get('deviceId'); setTimeout(load, 250); }
  </script>
</body>
</html>
