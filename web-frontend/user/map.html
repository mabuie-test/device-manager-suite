 <!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Mapa do Dispositivo — Final</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height:64vh; min-height:360px; border-radius:8px; box-shadow:0 6px 18px rgba(11,22,39,0.06); }
    .small { font-size:0.9rem; color:#6b7280; }
    .list-item { padding:8px;border-bottom:1px solid #eee }
    .controls { display:flex; gap:10px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    input#deviceId { padding:8px;border-radius:8px;border:1px solid #e6e9ef; min-width:280px }
    button { padding:8px 12px;border-radius:8px;border:none;background:#2563eb;color:#fff; cursor:pointer }
    button.ghost { background:transparent;color:#2563eb;border:1px solid #e6e9ef }
    .legend { display:flex; gap:12px; align-items:center; margin-top:8px; font-size:0.9rem }
    .legend .dot { width:14px;height:14px;border-radius:50%;display:inline-block }
    .dot-old{ background:#1976d2 }
    .dot-new{ background:#16a34a }
    .loader { display:inline-block;border:3px solid #f3f3f3;border-radius:50%;border-top:3px solid #2563eb;width:14px;height:14px;animation:spin 1s linear infinite;margin-left:8px;vertical-align:middle; }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    pre.raw-json { max-height:180px; overflow:auto; background:#0b1220;color:#dbeafe;padding:12px;border-radius:8px;margin-top:8px }
  </style>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <header style="display:flex;justify-content:space-between;align-items:center;margin:12px 0">
      <h1>Mapa (Final)</h1>
      <div>
        <a href="/user/dashboard.html">Voltar</a>
        <button id="logout" style="margin-left:8px">Logout</button>
      </div>
    </header>

    <div class="card">
      <div class="controls">
        <label style="flex:1">DeviceId: <input id="deviceId" placeholder="Cole o deviceId aqui" /></label>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnLoad">Carregar</button>
          <button id="btnClear" class="ghost">Limpar</button>
          <button id="btnToggleTrail" class="ghost">Ocultar trail</button>
        </div>
      </div>
      <div class="legend">
        <div><span class="dot dot-old"></span> Posição histórica</div>
        <div><span class="dot dot-new"></span> Última posição</div>
        <div style="margin-left:auto" id="status" class="small">Pronto</div>
      </div>
    </div>

    <div id="map" class="card"></div>

    <div class="card">
      <h3>Últimos pontos</h3>
      <ul id="list" style="list-style:none;padding-left:0;margin:0;max-height:280px;overflow:auto"></ul>

      <h4 style="margin-top:12px">Debug: primeira item bruto (se houver)</h4>
      <pre id="raw" class="raw-json">Nenhum</pre>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script>
    // --- utilitários
    function safeParseFloat(v) {
      if (v === null || v === undefined) return NaN;
      if (typeof v === 'number') return v;
      if (typeof v === 'string') {
        const n = parseFloat(v.replace(',', '.'));
        return isFinite(n) ? n : NaN;
      }
      return NaN;
    }
    function formatTime(ts) {
      try { return new Date(Number(ts)).toLocaleString(); } catch (e) { return String(ts); }
    }

    // extração robusta (aceita EN e PT). dá preferência a payload.location + payload.ts.
    function extractLocationFromItem(it) {
      // se for string -> tenta parse
      if (typeof it === 'string') {
        try { it = JSON.parse(it); } catch (e) { /* manter */ }
      }

      // se houver wrapper como { type:.., payload: {...} } usa payload
      const payload = it && (it.payload || it['payload'] || it['carga útil'] || it['carga_util'] || it['cargaÚtil'] || it['cargaUtil']);
      let pl = payload || it;

      if (typeof pl === 'string') {
        try { pl = JSON.parse(pl); } catch(e) { /* keep as is */ }
      }

      // localizar a chave de location/ localizacao / localização
      const possibleLoc = pl && (pl.location || pl.localizacao || pl['localização'] || pl['localizacao'] || pl.loc || pl.pos || pl.position);
      let lat = NaN, lon = NaN, accuracy = null, ts = null;

      if (possibleLoc) {
        let L = possibleLoc;
        if (typeof L === 'string') {
          try { L = JSON.parse(L); } catch(e) { /* ignore */ }
        }
        lat = safeParseFloat(L.lat || L.latitude || L.Lat || L['lat']);
        lon = safeParseFloat(L.lon || L.longitude || L.Lon || L['lon']);
        accuracy = L.accuracy || L.precision || L.precisao || L.precisão || L.acc;
      } else {
        // fallback: top-level fields
        lat = safeParseFloat(pl.lat || pl.latitude || pl.LAT || pl.Latitude);
        lon = safeParseFloat(pl.lon || pl.longitude || pl.LON || pl.Longitude);
        accuracy = pl.accuracy || pl.precision || pl.precisao || pl.precisão;
      }

      // timestamp: prioriza payload.ts
      ts = (pl && (pl.ts || pl.time || pl.timestamp || pl.date)) || (it && (it.ts || it.time || it.timestamp || it.date)) || Date.now();

      return { lat, lon, accuracy, ts, raw: it };
    }

    // --- variables map
    let map = null, markers = [], lastMarker = null, polyline = null, trailLatLngs = [], trailVisible = true;
    let socket = null, currentRoomDevice = null;

    function ensureMap() {
      if (!map) {
        map = L.map('map').setView([0,0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
      }
    }
    function clearAll() {
      if (!map) ensureMap();
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      if (lastMarker) { map.removeLayer(lastMarker); lastMarker = null; }
      if (polyline) { map.removeLayer(polyline); polyline = null; }
      trailLatLngs = [];
      document.getElementById('list').innerHTML = '';
      document.getElementById('raw').textContent = 'Nenhum';
    }
    function addHistoricMarker(lat, lon, accuracy, ts) {
      const latN = safeParseFloat(lat), lonN = safeParseFloat(lon);
      if (!isFinite(latN) || !isFinite(lonN)) return null;
      const marker = L.circleMarker([latN, lonN], { radius:6, color:'#1976d2', fillColor:'#1976d2', fillOpacity:0.9 }).addTo(map);
      const popup = `<div style="min-width:160px"><div><strong>${formatTime(ts)}</strong></div><div>Accuracy: ${accuracy||'-'}</div><div style="margin-top:6px"><a href="https://www.google.com/maps/search/?api=1&query=${latN},${lonN}" target="_blank">Abrir no Google Maps</a></div></div>`;
      marker.bindPopup(popup);
      markers.push(marker);
      return marker;
    }
    function setLastMarker(lat, lon, accuracy, ts) {
      const latN = safeParseFloat(lat), lonN = safeParseFloat(lon);
      if (!isFinite(latN) || !isFinite(lonN)) return;
      if (lastMarker) { map.removeLayer(lastMarker); lastMarker = null; }
      lastMarker = L.circleMarker([latN, lonN], { radius:9, color:'#0ea537', fillColor:'#0ea537', fillOpacity:0.95 }).addTo(map);
      const popup = `<div style="min-width:180px"><div><strong>${formatTime(ts)}</strong></div><div>Accuracy: ${accuracy||'-'}</div><div style="margin-top:6px"><a href="https://www.google.com/maps/search/?api=1&query=${latN},${lonN}" target="_blank">Abrir no Google Maps</a></div></div>`;
      lastMarker.bindPopup(popup);
      try { lastMarker.openPopup(); } catch(e) {}
      try { map.panTo([latN, lonN]); } catch(e) {}
    }
    function updatePolyline() {
      if (!map) return;
      if (polyline) map.removeLayer(polyline);
      if (!trailVisible || trailLatLngs.length < 2) { polyline = null; return; }
      polyline = L.polyline(trailLatLngs, { color: '#2563eb', weight: 4, opacity: 0.85 }).addTo(map);
    }
    function prependList(lat, lon, accuracy, ts) {
      const ul = document.getElementById('list');
      const li = document.createElement('li');
      li.className = 'list-item';
      li.innerHTML = `<strong>${formatTime(ts)}</strong><div>Lat: ${parseFloat(lat).toFixed(6)} Lon: ${parseFloat(lon).toFixed(6)}</div><div>Accuracy: ${accuracy||'-'}</div><div style="margin-top:6px"><a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank">Abrir no Google Maps</a></div>`;
      ul.insertBefore(li, ul.firstChild);
    }

    // load history
    async function loadHistory(deviceId) {
      document.getElementById('status').innerHTML = 'Carregando <span class="loader"></span>';
      try {
        const r = await apiFetch('/api/telemetry/' + encodeURIComponent(deviceId) + '/items?type=telemetry', { method: 'GET' });
        console.debug('raw history response:', r);
        // derive items (tolerant)
        let items = [];
        if (r == null) items = [];
        else if (Array.isArray(r)) items = r;
        else if (r.items && Array.isArray(r.items)) items = r.items;
        else if (r.data && Array.isArray(r.data)) items = r.data;
        else if (r.payload && Array.isArray(r.payload)) items = r.payload;
        else if (r.rows && Array.isArray(r.rows)) items = r.rows; // fallback
        else if (typeof r === 'object') {
          // maybe single item wrapper
          if (r.item) items = [r.item];
          else if (r.payload && typeof r.payload === 'object' && (r.payload.location || r.payload.localizacao)) items = [r];
          else items = r.items || [];
        }

        // keep copy of first raw item for debug view
        if (items.length > 0) {
          document.getElementById('raw').textContent = JSON.stringify(items[0], null, 2);
        } else {
          document.getElementById('raw').textContent = 'Nenhum item no histórico';
        }

        const pts = items.map(it => extractLocationFromItem(it))
                         .filter(p => isFinite(p.lat) && isFinite(p.lon))
                         .map(p => ({ lat: Number(p.lat), lon: Number(p.lon), acc: p.accuracy, ts: p.ts }));
        pts.sort((a,b) => Number(a.ts) - Number(b.ts));
        document.getElementById('status').innerText = 'OK';
        return pts;
      } catch (err) {
        console.error('loadHistory err', err);
        document.getElementById('status').innerText = 'Erro na comunicação';
        return [];
      }
    }

    // main load
    async function load() {
      const deviceId = document.getElementById('deviceId').value.trim();
      if (!deviceId) return alert('DeviceId required');
      ensureMap();
      clearAll();

      const pts = await loadHistory(deviceId);
      if (pts.length === 0) {
        map.setView([0,0], 2);
      } else {
        pts.forEach(p => {
          trailLatLngs.push([p.lat, p.lon]);
          addHistoricMarker(p.lat, p.lon, p.acc, p.ts);
        });
        const last = pts[pts.length - 1];
        setLastMarker(last.lat, last.lon, last.acc, last.ts);
        updatePolyline();
        try { map.fitBounds(trailLatLngs, { padding:[40,40], maxZoom:16 }); } catch(e) { map.setView([last.lat,last.lon],13); }
        const ul = document.getElementById('list'); ul.innerHTML = '';
        for (let i = pts.length -1; i >=0; i--) {
          const p = pts[i];
          const li = document.createElement('li');
          li.className = 'list-item';
          li.innerHTML = `<strong>${formatTime(p.ts)}</strong><div>Lat: ${p.lat.toFixed(6)} Lon: ${p.lon.toFixed(6)}</div><div>Accuracy: ${p.acc||'-'}</div><div style="margin-top:6px"><a href="https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lon}" target="_blank">Abrir no Google Maps</a></div>`;
          ul.appendChild(li);
        }
      }

      // socket setup
      try {
        if (socket) {
          try { socket.emit('leave_device_room', currentRoomDevice); } catch(e) {}
          try { socket.disconnect(); } catch(e) {}
          socket = null;
          currentRoomDevice = null;
        }
        socket = io(window.location.origin, { transports:['websocket','polling'] });
        currentRoomDevice = deviceId;
        socket.on('connect', () => {
          console.log('socket connected', socket.id);
          socket.emit('join_device_room', deviceId);
        });
        socket.off('telemetry'); socket.on('telemetry', data => handleRealtime(data));
        socket.off('telemetria'); socket.on('telemetria', data => handleRealtime(data)); // pt fallback
        // generic event catch-all for debugging
        socket.onAny((ev, payload) => {
          console.debug('socket event', ev, payload);
        });
      } catch (e) { console.error('socket setup err', e); }
    }

    function handleRealtime(data) {
      console.debug('realtime event payload:', data);
      const p = extractLocationFromItem(data);
      if (!isFinite(p.lat) || !isFinite(p.lon)) {
        console.warn('realtime: couldn't extract lat/lon from payload', data);
        return;
      }
      trailLatLngs.push([Number(p.lat), Number(p.lon)]);
      addHistoricMarker(p.lat, p.lon, p.accuracy, p.ts);
      setLastMarker(p.lat, p.lon, p.accuracy, p.ts);
      updatePolyline();
      prependList(p.lat, p.lon, p.accuracy, p.ts);
    }

    // UI bindings
    document.getElementById('btnLoad').addEventListener('click', load);
    document.getElementById('btnClear').addEventListener('click', () => { clearAll(); document.getElementById('status').innerText = 'Limpo'; });
    document.getElementById('btnToggleTrail').addEventListener('click', () => { trailVisible = !trailVisible; document.getElementById('btnToggleTrail').innerText = trailVisible ? 'Ocultar trail' : 'Mostrar trail'; updatePolyline(); });

    // auth + logout
    const token = localStorage.getItem('auth_token');
    if (!token) location.href = '/';
    document.getElementById('logout').addEventListener('click', ()=>{ localStorage.clear(); location.href='/' });

    // auto load if deviceId in query
    const params = new URLSearchParams(window.location.search);
    if (params.get('deviceId')) { document.getElementById('deviceId').value = params.get('deviceId'); setTimeout(load, 250); }
  </script>
</body>
</html>
