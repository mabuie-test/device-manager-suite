<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Mapa do Dispositivo</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    #map{height:480px;border-radius:8px;box-shadow:0 6px 18px rgba(11,22,39,0.06)}
    .list-item{padding:8px;border-bottom:1px solid #eee}
    .controls{display:flex;gap:10px;align-items:center;margin-bottom:8px}
    input#deviceId{padding:8px;border-radius:6px;border:1px solid #e6e9ef}
    button{padding:8px 12px;border-radius:6px;border:none;background:#2563eb;color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <div class="container">
    <header style="display:flex;justify-content:space-between">
      <h1>Mapa</h1>
      <div><a href="/user/dashboard.html">Voltar</a> <button id="logout">Logout</button></div>
    </header>

    <div class="card">
      <div class="controls">
        <label>DeviceId: <input id="deviceId" /></label>
        <button id="btnLoad">Carregar</button>
        <button id="btnClear" style="background:#e6eefc;color:#0b2f6c;margin-left:8px">Limpar</button>
      </div>
      <div id="status" class="small">Pronto</div>
    </div>

    <div id="map" class="card"></div>
    <div class="card"><h3>Últimos pontos</h3><ul id="list" style="list-style:none;padding-left:0;margin:0"></ul></div>
  </div>

  <script src="/js/api.js"></script>
  <script>
    // garante autenticação mínima
    if (!localStorage.getItem('auth_token')) location.href = '/';
    document.getElementById('logout').addEventListener('click', ()=>{ localStorage.clear(); location.href='/' });

    // util helpers
    function toNum(v){ if (v===null||v===undefined) return NaN; if (typeof v==='number') return v; return parseFloat(String(v).replace(',', '.')); }
    function fmtTime(ts){ try { return new Date(Number(ts)).toLocaleString(); } catch(e){ return String(ts); } }

    // map state
    let map = null;
    let markers = [];       // historical markers
    let lastMarker = null;  // highlighted last
    let trail = null;       // polyline
    let trailLatLngs = [];
    let socket = null;
    let currentDeviceRoom = null;

    function ensureMap(){
      if (!map){
        map = L.map('map').setView([0,0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
      }
    }

    function clearAll(){
      if (!map) ensureMap();
      markers.forEach(m=>map.removeLayer(m)); markers = [];
      if (lastMarker) { map.removeLayer(lastMarker); lastMarker = null; }
      if (trail) { map.removeLayer(trail); trail = null; }
      trailLatLngs = [];
      document.getElementById('list').innerHTML = '';
      document.getElementById('status').innerText = 'Limpo';
      // socket cleanup
      if (socket){
        try{ socket.emit('leave_device_room', currentDeviceRoom); }catch(e){}
        try{ socket.disconnect(); }catch(e){}
        socket = null; currentDeviceRoom = null;
      }
    }

    function addHistoryMarker(lat, lon, acc, ts){
      const la = Number(lat), lo = Number(lon);
      if (!isFinite(la) || !isFinite(lo)) return;
      const m = L.circleMarker([la, lo], { radius:6, color:'#1976d2', fillColor:'#1976d2', fillOpacity:0.9 }).addTo(map);
      const popup = `<div><strong>${fmtTime(ts)}</strong><div>Accuracy: ${acc||'-'}</div><div style="margin-top:6px"><a href="https://www.google.com/maps/search/?api=1&query=${la},${lo}" target="_blank">Abrir no Google Maps</a></div></div>`;
      m.bindPopup(popup);
      markers.push(m);
    }

    function setLastPosition(lat, lon, acc, ts){
      const la = Number(lat), lo = Number(lon);
      if (!isFinite(la) || !isFinite(lo)) return;
      if (lastMarker) { map.removeLayer(lastMarker); lastMarker = null; }
      lastMarker = L.circleMarker([la, lo], { radius:9, color:'#16a34a', fillColor:'#16a34a', fillOpacity:0.95 }).addTo(map);
      const popup = `<div><strong>${fmtTime(ts)}</strong><div>Accuracy: ${acc||'-'}</div><div style="margin-top:6px"><a href="https://www.google.com/maps/search/?api=1&query=${la},${lo}" target="_blank">Abrir no Google Maps</a></div></div>`;
      lastMarker.bindPopup(popup);
      try{ lastMarker.openPopup(); }catch(e){}
      try{ map.panTo([la, lo]); }catch(e){}
    }

    function updateTrail(){
      if (trail) { map.removeLayer(trail); trail = null; }
      if (trailLatLngs.length < 2) return;
      trail = L.polyline(trailLatLngs, { color:'#2563eb', weight:4, opacity:0.85 }).addTo(map);
    }

    function prependListItem(lat, lon, acc, ts){
      const ul = document.getElementById('list');
      const li = document.createElement('li');
      li.className = 'list-item';
      li.innerHTML = `<strong>${fmtTime(ts)}</strong><div>Lat: ${Number(lat).toFixed(6)} Lon: ${Number(lon).toFixed(6)}</div><div>Accuracy: ${acc||'-'}</div><div style="margin-top:6px"><a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank">Abrir no Google Maps</a></div>`;
      ul.insertBefore(li, ul.firstChild);
    }

    // extrai lat/lon/accuracy/ts do item retornado pelo backend
    function extractPointFromItem(it){
      // it pode ter it.payload.location.lat/lon e it.payload.ts
      const payload = (it && (it.payload || it['payload'])) || it || {};
      const pl = (typeof payload === 'string') ? (()=>{ try { return JSON.parse(payload); } catch(e){ return payload; } })() : payload;
      const loc = pl && (pl.location || pl.localizacao || pl['localização']);
      let lat = NaN, lon = NaN, acc = null, ts = null;
      if (loc){
        lat = toNum(loc.lat || loc.latitude || loc.Lat);
        lon = toNum(loc.lon || loc.longitude || loc.Lon);
        acc = loc.accuracy || loc.precision || loc.precisao || loc.precisão;
        ts = pl.ts || pl.t || pl.time || pl.timestamp || pl.ts || it.ts;
      } else {
        lat = toNum(pl.lat || pl.latitude);
        lon = toNum(pl.lon || pl.longitude);
        acc = pl.accuracy || pl.precision;
        ts = pl.ts || pl.time || pl.timestamp || it.ts;
      }
      // final fallback
      if (!ts) ts = it && (it.ts || it.time) || Date.now();
      return { lat, lon, acc, ts };
    }

    // carrega histórico e desenha tudo
    async function load(){
      const deviceId = document.getElementById('deviceId').value.trim();
      if (!deviceId) return alert('DeviceId required');
      ensureMap();
      // limpar antes de carregar
      markers.forEach(m=>map.removeLayer(m)); markers=[]; if (lastMarker){ map.removeLayer(lastMarker); lastMarker = null; } if (trail){ map.removeLayer(trail); trail = null; } trailLatLngs=[]; document.getElementById('list').innerHTML=''; document.getElementById('status').innerText='Carregando...';

      try {
        const r = await apiFetch('/api/telemetry/' + encodeURIComponent(deviceId) + '/items?type=telemetry', { method:'GET' });
        // r pode ser { ok:true, items:[...] } ou outras variações
        let items = [];
        if (!r) items = [];
        else if (Array.isArray(r)) items = r;
        else if (r.items && Array.isArray(r.items)) items = r.items;
        else if (r.payload && Array.isArray(r.payload)) items = r.payload;
        else if (r.data && Array.isArray(r.data)) items = r.data;
        else if (r.rows && Array.isArray(r.rows)) items = r.rows;
        else items = r.items || [];

        // cria pontos
        const pts = [];
        for (let i=0;i<items.length;i++){
          const p = extractPointFromItem(items[i]);
          if (isFinite(p.lat) && isFinite(p.lon)){
            pts.push(p);
          }
        }

        if (pts.length === 0){
          document.getElementById('status').innerText = 'Nenhum ponto com lat/lon no histórico';
          map.setView([0,0],2);
        } else {
          // ordenar cronologicamente
          pts.sort((a,b)=>Number(a.ts)-Number(b.ts));
          pts.forEach(pt=>{
            trailLatLngs.push([Number(pt.lat), Number(pt.lon)]);
            addHistoryMarker(pt.lat, pt.lon, pt.acc, pt.ts);
          });
          const last = pts[pts.length-1];
          setLastPosition(last.lat, last.lon, last.acc, last.ts);
          updateTrail();
          try { map.fitBounds(trailLatLngs, { padding:[40,40], maxZoom:16 }); } catch(e){ map.setView([last.lat,last.lon],13); }
          // popular lista (mais recente primeiro)
          for (let i=pts.length-1;i>=0;i--){
            prependListItem(pts[i].lat, pts[i].lon, pts[i].acc, pts[i].ts);
          }
          document.getElementById('status').innerText = 'OK (' + pts.length + ' pontos)';
        }

        // realtime socket: conecta e entra na sala
        if (socket){ try{ socket.emit('leave_device_room', currentDeviceRoom); }catch(e){} try{ socket.disconnect(); }catch(e){} socket = null; currentDeviceRoom = null; }
        // conecta ao mesmo origin
        socket = io(window.location.origin, { transports:['websocket','polling'] });
        currentDeviceRoom = deviceId;
        socket.on('connect', ()=>{ console.log('socket connected', socket.id); socket.emit('join_device_room', deviceId); });
        // evento padrão 'telemetry'
        socket.on('telemetry', data=>{ try { const p = extractPointFromItem(data); if (isFinite(p.lat) && isFinite(p.lon)){ trailLatLngs.push([Number(p.lat), Number(p.lon)]); addHistoryMarker(p.lat,p.lon,p.acc,p.ts); setLastPosition(p.lat,p.lon,p.acc,p.ts); updateTrail(); prependListItem(p.lat,p.lon,p.acc,p.ts); } } catch(e){ console.error(e); } });
        // fallback pt
        socket.on('telemetria', data=>{ try { const p = extractPointFromItem(data); if (isFinite(p.lat) && isFinite(p.lon)){ trailLatLngs.push([Number(p.lat), Number(p.lon)]); addHistoryMarker(p.lat,p.lon,p.acc,p.ts); setLastPosition(p.lat,p.lon,p.acc,p.ts); updateTrail(); prependListItem(p.lat,p.lon,p.acc,p.ts); } } catch(e){ console.error(e); } });
      } catch (err) {
        console.error('load err', err);
        document.getElementById('status').innerText = 'Erro ao carregar histórico';
      }
    }

    document.getElementById('btnLoad').addEventListener('click', load);
    document.getElementById('btnClear').addEventListener('click', clearAll);

    // auto load se deviceId na querystring
    const params = new URLSearchParams(window.location.search);
    if (params.get('deviceId')) { document.getElementById('deviceId').value = params.get('deviceId'); setTimeout(load, 200); }
  </script>
</body>
</html>
