<!doctype html>
<html>
<head><meta charset="utf-8"/><title>User Dashboard</title><link rel="stylesheet" href="/css/styles.css"></head>
<body>
  <div class="container">
    <header><h1>User Dashboard</h1><button id="logout">Logout</button></header>
    <div class="card">
      <h3>Profile</h3>
      <pre id="profile">Loading...</pre>
    </div>

    <div class="card">
      <h3>Enviar comprovativo de pagamento</h3>
      <input id="amount" type="number" placeholder="Amount" />
      <input id="method" placeholder="Method (e.g. bank transfer)" />
      <input id="note" placeholder="Note (optional)" />
      <input id="file" type="file" />
      <button id="sendPayment">Enviar</button>
      <p id="payMsg" class="small"></p>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('auth_token');
    if (!token) { location.href='/'; }
    const headers = { 'Authorization': 'Bearer ' + token };

    async function loadProfile(){
      const r = await fetch('/api/auth/me', { headers }).then(r=>r.json());
      document.getElementById('profile').innerText = JSON.stringify(r, null, 2);
    }

    document.getElementById('logout').addEventListener('click', ()=>{ localStorage.clear(); location.href='/' });

    document.getElementById('sendPayment').addEventListener('click', async () => {
      const fileEl = document.getElementById('file');
      const amount = parseFloat(document.getElementById('amount').value || 0);
      const method = document.getElementById('method').value;
      const note = document.getElementById('note').value;

      if (fileEl.files.length === 0) {
        document.getElementById('payMsg').innerText = 'Escolhe um ficheiro';
        return;
      }

      // upload file first to /api/media/:deviceId/upload (we can set deviceId = user-id or 'payment')
      const form = new FormData();
      form.append('media', fileEl.files[0]);

      // choose deviceId placeholder "payment" to attach file; backend stores metadata.deviceId
      const uploadRes = await fetch('/api/media/payment/upload', { method:'POST', headers: { 'Authorization': 'Bearer ' + token }, body: form }).then(r=>r.json());
      if (!uploadRes.ok) {
        document.getElementById('payMsg').innerText = 'Upload failed: ' + JSON.stringify(uploadRes);
        return;
      }

      const mediaFileId = uploadRes.fileId;
      // create payment record
      const createRes = await fetch('/api/payments', { method:'POST', headers: { 'Content-Type':'application/json', 'Authorization':'Bearer ' + token }, body: JSON.stringify({ amount, method, note, mediaFileId }) }).then(r=>r.json());
      if (createRes.ok) {
        document.getElementById('payMsg').innerText = 'Pagamento enviado. ID: ' + createRes.id;
      } else {
        document.getElementById('payMsg').innerText = 'Erro ao criar pagamento: ' + JSON.stringify(createRes);
      }
    });

    loadProfile();
  </script>
</body>
</html>