<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Device Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="css/style.css"/>
  <style>
    #map { height: 70vh; }
    #timeline { height: 28vh; overflow:auto; padding:8px; border-top:1px solid #ccc }
    .event { padding:6px; border-bottom:1px solid #eee }
  </style>
</head>
<body>
  <div class="topbar"><h2>Device Map</h2></div>
  <div id="map"></div>
  <div id="timeline"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const API_BASE = location.origin + '/api';
    const token = localStorage.getItem('token');
    if (!token) alert('Visor público — para admin faça login primeiro');

    const params = new URLSearchParams(location.search);
    const deviceId = params.get('deviceId') || prompt('Qual deviceId?');

    const map = L.map('map').setView([0,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom: 19 }).addTo(map);
    const socket = io(location.origin);
    socket.on('connect', ()=>{ socket.emit('join_device_room', deviceId); });
    socket.on('telemetry', ev => {
      if (ev.deviceId !== deviceId) return;
      if (ev.location) addMarker(ev);
    });

    function addMarker(ev) {
      const lat = ev.location.lat, lon = ev.location.lon;
      const ts = new Date(ev.ts).toLocaleString();
      const marker = L.marker([lat, lon]).addTo(map);
      const popupHtml = `<b>${ts}</b><br/>Lat: ${lat.toFixed(6)} Lon: ${lon.toFixed(6)}<br/>
        <a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}">Navegar no GMaps</a>`;
      marker.bindPopup(popupHtml);
      map.setView([lat, lon], 15);
      const timeline = document.getElementById('timeline');
      const div = document.createElement('div');
      div.className='event';
      div.innerHTML = popupHtml;
      timeline.prepend(div);
    }

    async function loadHistory() {
      const res = await fetch(`${API_BASE}/telemetry/${deviceId}/history`, {
        headers: token ? { Authorization: 'Bearer ' + token } : {}
      });
      const arr = await res.json();
      arr.forEach(a => { if (a.location) addMarker(a); });
    }
    loadHistory();
  </script>
</body>
</html>
